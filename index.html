<!DOCTYPE html>
<html lang="en">
<!-- імпортуємо код з іншого html документу -->
<!-- передаємо йому змінну title, яка може бути різною для кожної сторінки -->
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.min.css?_v=20230926225514">
  <title>Enigma ▪ Main page</title>
</head>

<body>
  <header class="header">
  <!-- <picture><source srcset="img/avatar.webp" type="image/webp"><img src="img/avatar.png" alt=""></picture> -->
</header>
  <main>

    <div class="hero">
      <div class="card">
        <!-- <img width=300 height=300 src="img/avatar.png" alt="Decoding image" id="upload-img" style="
          object-fit: cover; width:fit-content"> -->
        <div>
          <!-- <label for="input-file">Update image</label> -->
          <input type="file" accept="image/jpeg, image/jpg, image/png" id="input-file" required>
        </div>
      </div>
      <canvas id="canvas1" style="border: 3px solid #555;width: 200px;height: 200px;">
      </canvas>
      <a id="canvas-download"href="#" download>Download</a>

    </div>

  </main>
  <footer class="footer"></footer>

  <!-- <script src="js/app.min.js?_v=20230926225514"></script> -->
  <script>
    // const inputImg = document.getElementById('upload-img')
    const inputFile = document.getElementById('input-file')
    const canvasDownload = document.getElementById('canvas-download')
    
    //Realtime update img
    inputFile.onchange = () => {
      updCanvas(URL.createObjectURL(inputFile.files[0]))
      // inputImg.src = URL.createObjectURL(inputFile.files[0])
      // inputImg.src = inputFile.value;   
      // let inputFile = document.getElementById('input-file')
    }
    
    //temp
    updCanvas('img/avatar.png');
    
    //Realtime update canvas on img input
    function updCanvas(src) {
      const canvas = document.getElementById('canvas1')
      const ctx = canvas.getContext('2d')
      canvas.width = 200
      canvas.height = 200
      const image1 = new Image();
      image1.src = src
            
      image1.addEventListener('load', () => {
        ctx.drawImage(image1, 0, 0, canvas.width, canvas.height)
        const scannedImage = ctx.getImageData(0, 0, canvas.width, canvas.height)
        
        //Editing image
        const scannedData = scannedImage.data
        
        let imgPixels = scannedData.length / 4        
        //Text length
        let step = imgPixels / 80
        
        for (let i = 0; i < scannedData.length; i += step*4) {
          //even 4th element in scannedData - begin of RGBA value
          let rgba = [];
          for (let j = 0; j < 4; j++) {
            rgba.push(scannedData[i + j])
          }

          //Manipulation
          //-GrayMode
          rgba = rgba.map((item =>
           item = rgba.reduce((a, b) => a + b) / rgba.length))   

          //Return changes
          for (let k = 0; k < 4; k++) {
            scannedData[i + k] = rgba[k]
          }
        }

        //Rewrite picture
        scannedImage.data = scannedData
        ctx.putImageData(scannedImage, 0, 0)
        //Make link to download
        canvasDownload.href = canvas.toDataURL()
      })

    }
  </script>
</body>

</html>